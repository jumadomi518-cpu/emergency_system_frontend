<!DOCTYPE html>
<html>
<head>
  <title>Emergency Response Dashboard</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif;}
    body { padding:10px; }
    h2 { text-align:center; margin-bottom:10px; }
    #map { height:400px; margin-bottom:10px; }
    table { width:100%; border-collapse:collapse; }
    th,td { border:1px solid #ccc; padding:6px; text-align:center; }
    button { padding:5px 8px; border:none; border-radius:4px; cursor:pointer; }
    .accept { background:green; color:white;}
    .reject { background:red; color:white;}
    .resolve { background:purple; color:white;}
    .routeOption { background:#007bff; color:white; margin:2px;}
    #routeInfo { margin-top:8px; font-size:14px; }
    #debugPanel {
      position:fixed; bottom:0; left:0; width:100%;
      max-height:150px; overflow-y:auto;
      background:rgba(0,0,0,0.8); color:#0f0;
      font-size:11px; padding:5px; font-family:monospace;
    }
  </style>
</head>
<body>

<h2>Emergency Response Dashboard</h2>
<div id="map"></div>
<div id="routeInfo"></div>

<table>
<thead>
<tr><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="debugPanel"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// DEBUG LOG
function log(msg){
  const panel = document.getElementById("debugPanel");
  const time = new Date().toLocaleTimeString();
  panel.innerText += `[${time}] ${typeof msg==="object"?JSON.stringify(msg):msg}\n`;
  panel.scrollTop = panel.scrollHeight;
}


if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/swr.js")
    .then(() => log("SW registered"))
    .catch(err => log("SW registration failed: " + err));
}

// CONFIG
const WS_URL = "wss://campus-emergency-server.onrender.com";
const role = localStorage.getItem("role");
let ws;
let activeAssignment = null;


// MAP
const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const emergencyMarkers = {};
const responderMarkers = {};
const routeLines = {};
let currentWatchId = null;


// RESPONDER ICON
const responderIcon = L.divIcon({
  html:`<div id="responderArrow" style="
        width:30px;height:30px;
        background:url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center;
        background-size:contain;
        transform:rotate(0deg);"></div>`,
  className:"",
  iconSize:[30,30]
});


// CONNECT WEBSOCKET
function connectWS(){
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    const token = localStorage.getItem("token");
    if(token) ws.send(JSON.stringify({ token }));
    log("WS Connected");
    log("Role: " + role);
  };

  ws.onclose = ()=>{
    log("WS Reconnecting...");
    setTimeout(connectWS,3000);
  };

  ws.onmessage = handleWSMessage;
}
connectWS();

// HANDLE MESSAGES
function handleWSMessage(e){
  const msg = JSON.parse(e.data);
  log(msg);

  // After authentication → send initial location
  if (msg.type === "AUTH_SUCCESS") {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        ws.send(JSON.stringify({
          type: "LOCATION_UPDATE",
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        }));
      }, console.error, { enableHighAccuracy: true });
    }
  }

  // Only responders handle assignments
  if(msg.type === "EMERGENCY_ASSIGNMENT" && role !== "user"){
    showAssignmentUI(msg);
    log("Emergency Assignment received " + msg);
  }

  // If victim gets responder accepted
  if(msg.type === "RESPONDER_ACCEPTED"){
    log("Responder accepted alert " + msg.alertId);
  }

  if(msg.type === "ALERT_RESOLVED"){
    removeAlert(msg.alertId);
  }
}


// SHOW ASSIGNMENT UI
function showAssignmentUI(msg){

  activeAssignment = msg;

  // Add marker for emergency
  if(!emergencyMarkers[msg.alertId]){
    emergencyMarkers[msg.alertId] =
      L.marker([msg.latitude,msg.longitude]).addTo(map);
  }

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${msg.name || "Unknown"}</td>
    <td>${msg.phone || "Unknown"}</td>
    <td>${msg.message}</td>
    <td class="status">
      <button onclick="respondToAssignment(${msg.alertId}, true)">Accept</button>
      <button onclick="respondToAssignment(${msg.alertId}, false)">Reject</button>
    </td>
  `;

  document.getElementById("rows").appendChild(row);
}

// RESPOND TO ASSIGNMENT
function respondToAssignment(alertId, accept){
  const status = document.querySelector(".status");
  ws.send(JSON.stringify({
    type:"RESPONDER_RESPONSE",
    alertId,
    accept
  }));

  if(accept && activeAssignment){
 
  status.innerText = "Accepted";
    startNavigation(
      alertId,
      activeAssignment.latitude,
      activeAssignment.longitude
    );
  } else {
 status.innerText = "rejected";
  }
}


// START NAVIGATION
function startNavigation(alertId, destLat, destLng){

  if(currentWatchId) navigator.geolocation.clearWatch(currentWatchId);

  if(!responderMarkers[alertId]){
    responderMarkers[alertId] =
      L.marker([0,0],{icon:responderIcon}).addTo(map);
  }

  navigator.geolocation.getCurrentPosition(pos => {

  const startLat = pos.coords.latitude;
  const startLng = pos.coords.longitude;

  responderMarkers[alertId].setLatLng([startLat,startLng]);

  fetchRoutes(alertId,startLat,startLng,destLat,destLng);

});


  currentWatchId = navigator.geolocation.watchPosition(pos=>{

    const startLat = pos.coords.latitude;
    const startLng = pos.coords.longitude;

    responderMarkers[alertId].setLatLng([startLat,startLng]);

    updateHeading(startLat,startLng,destLat,destLng);

    ws.send(JSON.stringify({
      type:"LOCATION_UPDATE",
      alertId,
      latitude:startLat,
      longitude:startLng
    }));

  }, console.error, { enableHighAccuracy:true });
}


// FETCH ROUTES (OSRM)
function fetchRoutes(alertId,sLat,sLng,dLat,dLng){

  fetch(`https://router.project-osrm.org/route/v1/driving/${sLng},${sLat};${dLng},${dLat}?alternatives=true&overview=full&geometries=geojson`)
  .then(r=>r.json())
  .then(data=>{
    if(!data.routes) return;

    const routeDiv = document.getElementById("routeInfo");
    routeDiv.innerHTML="";

    data.routes.forEach((route,index)=>{

      const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
      const distance = (route.distance/1000).toFixed(2);
      const duration = (route.duration/60).toFixed(1);

      const btn = document.createElement("button");
      btn.innerText=`Route ${index+1} - ${distance} km - ${duration} min`;

      btn.onclick=()=>{
        if(routeLines[alertId]) map.removeLayer(routeLines[alertId]);

        routeLines[alertId] = L.polyline(coords,{color:"blue"}).addTo(map);
        map.fitBounds(routeLines[alertId].getBounds());

        routeDiv.innerHTML=`Selected Route: ${distance} km - ${duration} min`;

        ws.send(JSON.stringify({
          type:"SELECTED_ROUTE",
          alertId,
          routeIndex:index,
          distance,
          duration,
          routeCoordinates: coords
        }));
      };

      routeDiv.appendChild(btn);
    });
  });
}


function updateHeading(currentLat, currentLng, destLat, destLng) {

  // Convert degrees to radians
  const toRad = deg => deg * Math.PI / 180;
  const toDeg = rad => rad * 180 / Math.PI;

  const φ1 = toRad(currentLat);
  const φ2 = toRad(destLat);
  const Δλ = toRad(destLng - currentLng);

  // Bearing calculation
  const y = Math.sin(Δλ) * Math.cos(φ2);
  const x =
    Math.cos(φ1) * Math.sin(φ2) -
    Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);

  let bearing = Math.atan2(y, x);

  // Convert radians → degrees
  bearing = toDeg(bearing);

  // Normalize to 0–360
  bearing = (bearing + 360) % 360;

  // Rotate arrow
  const arrow = document.getElementById("responderArrow");
  if (arrow) {
    arrow.style.transform = `rotate(${bearing}deg)`;
  }
}


// REMOVE ALERT
function removeAlert(id){
  if(emergencyMarkers[id]) map.removeLayer(emergencyMarkers[id]);
  if(routeLines[id]) map.removeLayer(routeLines[id]);
  delete routeLines[id];
}
</script>
</body>
</html>
