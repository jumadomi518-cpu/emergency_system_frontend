<!DOCTYPE html>
<html>
<head>
  <title>Emergency Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * { margin: 0; padding: 0; font-family: "Poppins", sans-serif; box-sizing: border-box; }
    body { font-family: Arial; padding: 10px; }
    h2 { text-align: center; white-space: nowrap; overflow: scroll; padding: 0.5em; }
    #map { height: 400px; margin-bottom: 10px; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    td, th { padding:5px; border:1px solid #ccc; text-align:center; }
    button { padding: 0.3em 0.6em; border-radius: 0.3em; border: none; cursor: pointer; }
    .accept { background-color: green; color:white; }
    .reject { background-color: red; color:white; }
    .resolve { background-color: purple; color:white; }
    #debugPanel {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%; max-height: 200px;
      overflow-y: auto;
      background: rgba(0,0,0,0.7);
      color: white; font-size: 12px;
      z-index: 9999; padding: 5px;
      font-family: monospace;
    }
  </style>
</head>
<body>

<h2>Emergency Response Dashboard</h2>
<div id="map"></div>

<table>
  <thead>
    <tr><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/********** LOGGING **********/
function log(msg){
  console.log(msg);
  const panel = document.getElementById("debugPanel");
  if(!panel) return;
  const time = new Date().toLocaleTimeString();
  panel.innerText += `[${time}] ${typeof msg === "object" ? JSON.stringify(msg) : msg}\n`;
  panel.scrollTop = panel.scrollHeight;
}

/********** CONFIG **********/
const WS_URL = "wss://campus-emergency-server.onrender.com";
const userId = localStorage.getItem("userId");
const role = localStorage.getItem("role");

let ws;

/********** MAP SETUP **********/
const map = L.map("map").setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const emergencyMarkers = {};
const responderMarkers = {};
const routeLines = {};
const activeAlerts = {};

let victimMarker = null; // smooth victim tracking

/********** WEBSOCKET **********/
function connectWS(){
  ws = new WebSocket(WS_URL);
  ws.onopen = () => {
    const token = localStorage.getItem("token");
    if(token) ws.send(JSON.stringify({ token }));
    log("WebSocket connected, role: " + role);
  };
  ws.onclose = () => {
    log("WebSocket disconnected, retrying in 3s");
    setTimeout(connectWS, 3000);
  };
  ws.onmessage = handleWSMessage;
}
connectWS();

/********** LOGICAL FUNCTIONS **********/
function resolve(alertId){
  if(ws && ws.readyState === WebSocket.OPEN)
    ws.send(JSON.stringify({type:"RESOLVE_ALERT", alertId}));
}

function respond(alertId, accept){
  if(ws && ws.readyState === WebSocket.OPEN)
    ws.send(JSON.stringify({type:"RESPONDER_RESPONSE", alertId, accept}));
  const row = document.getElementById("a"+alertId);
  if(row) row.cells[3].innerHTML = accept ? "Accepted" : "Rejected";
}

/********** SMOOTH MOVE HELPER **********/
function smoothMoveMarker(marker, newLatLng){
  if(!marker) return;
  const currentLatLng = marker.getLatLng();
  const steps = 20;
  let step = 0;
  const latStep = (newLatLng[0] - currentLatLng.lat)/steps;
  const lngStep = (newLatLng[1] - currentLatLng.lng)/steps;

  function animateStep(){
    if(step>=steps) return;
    marker.setLatLng([
      currentLatLng.lat + latStep*step,
      currentLatLng.lng + lngStep*step
    ]);
    step++;
    requestAnimationFrame(animateStep);
  }
  animateStep();
}

/********** HANDLE WS MESSAGES **********/
function handleWSMessage(e){
  try{
    const msg = JSON.parse(e.data);

    if(msg.type==="VALIDATE_ALERT"){
      const a = msg;
      log(a);
      activeAlerts[a.alertId] = a;

      // Map marker
      emergencyMarkers[a.alertId] = L.marker([a.latitude,a.longitude]).addTo(map).bindPopup(a.name);
      map.setView([a.latitude,a.longitude], 15);

      // Table
      let actionHTML = role==='admin' 
        ? `<button class="resolve" onclick="resolve(${a.alertId})">Resolve</button>`
        : `<button class="accept" onclick="respond(${a.alertId},true)">Accept</button>
           <button class="reject" onclick="respond(${a.alertId},false)">Reject</button>`;
      if(!document.getElementById("a"+a.alertId)){
        document.getElementById("rows").innerHTML += `
          <tr id="a${a.alertId}">
            <td>${a.name}</td>
            <td>${a.phone}</td>
            <td>${a.message||""}</td>
            <td>${actionHTML}</td>
          </tr>`;
      }
    }

    if(msg.type==="ALERT_RESOLVED"){
      const row = document.getElementById("a"+msg.alertId);
      if(row) row.style.opacity = 0.5;
      if(emergencyMarkers[msg.alertId]) map.removeLayer(emergencyMarkers[msg.alertId]);
      if(responderMarkers[msg.alertId]) map.removeLayer(responderMarkers[msg.alertId]);
      if(routeLines[msg.alertId]) map.removeLayer(routeLines[msg.alertId]);
      delete activeAlerts[msg.alertId];
    }

    // Responder assigned to alert
    if(msg.type==="EMERGENCY_ASSIGNMENT" && role!=='admin'){
      activeAlerts[msg.alertId] = msg;
      drawResponderRoute(msg.alertId, msg.latitude, msg.longitude);
    }

    // Responder accepted (victim view)
    if(msg.type==="RESPONDER_ACCEPTED"){
      trackResponder(msg.responder, msg.alertId);
    }

  }catch(err){ log("WS message error:"+err);}
}

/********** VICTIM LOCATION TRACKING **********/
let watchId = null;

function startVictimTracking() {
  if(!navigator.geolocation) return;
  if(watchId) return;

  watchId = navigator.geolocation.watchPosition(pos=>{
    const latlng = [pos.coords.latitude, pos.coords.longitude];

    if(!victimMarker){
      victimMarker = L.marker(latlng, {icon:L.icon({iconUrl:"victim.png",iconSize:[32,32]})})
        .addTo(map)
        .bindPopup("Your location");
    } else {
      smoothMoveMarker(victimMarker, latlng);
    }

    // Center on user without locking map (like professional apps)
    map.panTo(latlng, {animate:true, duration:0.5});

    // Send location to WS
    if(ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({type:"LOCATION_UPDATE", latitude:latlng[0], longitude:latlng[1]}));
    }
  }, err=>log(err), {enableHighAccuracy:true});
}

/********** TRACK RESPONDER **********/
async function drawResponderRoute(alertId, destLat, destLng){
  if(!navigator.geolocation) return;

  // Create marker once
  if(!responderMarkers[alertId]){
    responderMarkers[alertId] = L.marker([0,0], {icon:L.icon({iconUrl:"responder.png",iconSize:[32,32]})})
      .addTo(map);
  }

  let lastPos = null;

  function updateRoute(pos){
    const start = [pos.coords.latitude, pos.coords.longitude];
    const end = [destLat, destLng];

    // Move marker smoothly
    if(lastPos){
      smoothMoveMarker(responderMarkers[alertId], start);
    } else {
      responderMarkers[alertId].setLatLng(start);
    }
    lastPos = start;

    // Fetch polyline
    fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
      .then(r=>r.json())
      .then(data=>{
        if(!data.routes || data.routes.length===0) return;
        const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
        if(routeLines[alertId]) map.removeLayer(routeLines[alertId]);
        routeLines[alertId] = L.polyline(coords,{color:"blue"}).addTo(map);
      })
      .catch(err=>console.error(err));

    // Send live location to WS
    if(ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({type:"LOCATION_UPDATE", latitude:start[0], longitude:start[1]}));
    }
  }

  // Initial fetch
  navigator.geolocation.getCurrentPosition(updateRoute, err=>console.error(err), {enableHighAccuracy:true});
  // Watch position
  navigator.geolocation.watchPosition(updateRoute, err=>console.error(err), {enableHighAccuracy:true});
}

/********** TRACK ANY OTHER RESPONDER (victim view) **********/
async function trackResponder(responder, alertId){
  if(!emergencyMarkers[alertId]) return;

  const start = [responder.lat,responder.lng];
  const end = [emergencyMarkers[alertId].getLatLng().lat, emergencyMarkers[alertId].getLatLng().lng];

  // Marker
  if(!responderMarkers[responder.id]){
    responderMarkers[responder.id] = L.marker(start,{icon:L.icon({iconUrl:"responder.png",iconSize:[32,32]})}).addTo(map);
  } else {
    smoothMoveMarker(responderMarkers[responder.id], start);
  }

  // Route
  fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`)
    .then(r=>r.json())
    .then(data=>{
      if(!data.routes || data.routes.length===0) return;
      const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
      if(routeLines[responder.id]) map.removeLayer(routeLines[responder.id]);
      routeLines[responder.id] = L.polyline(coords,{color:"blue"}).addTo(map);
    })
    .catch(err=>console.error(err));
}

</script>

<div id="debugPanel"></div>

</body>
</html>
