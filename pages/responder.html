<!DOCTYPE html>
<html>
<head>
  <title>Emergency Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * { margin: 0; padding: 0; font-family: "Poppins", sans-serif; box-sizing: border-box; }
    body { font-family: Arial; padding: 10px; }
    h2 { text-align: center; white-space: nowrap; overflow: scroll; padding: 0.5em; }
    #map { height: 400px; margin-bottom: 10px; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    td, th { padding:5px; border:1px solid #ccc; text-align:center; }
    button { padding: 0.3em 0.6em; border-radius: 0.3em; border: none; cursor: pointer; }
    .accept { background-color: green; color:white; }
    .reject { background-color: red; color:white; }
    .resolve { background-color: purple; color:white; }
  </style>
</head>
<body>

<h2>Emergency Response Dashboard</h2>
<div id="map"></div>

<table>
  <thead>
    <tr><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

function log(msg){
  console.log(msg); // keep browser console logging for later
  const panel = document.getElementById("debugPanel");
  if(!panel) return;
  const time = new Date().toLocaleTimeString();
  panel.innerText += `[${time}] ${typeof msg === "object" ? JSON.stringify(msg) : msg}\n`;
  panel.scrollTop = panel.scrollHeight; // auto-scroll
}

// CONFIG
const WS_URL = "wss://campus-emergency-server.onrender.com";
const userId = localStorage.getItem("userId");
const role = localStorage.getItem("role");

let ws;

// MAP SETUP
const map = L.map("map").setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const emergencyMarkers = {}; // alertId marker
const responderMarkers = {}; // alertId responder marker
const routeLines = {};       // alertId polyline
const activeAlerts = {};     // alertId alert data

// WEBSOCKET WITH RECONNECT
function connectWS(){
  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    const token = localStorage.getItem("token");
    if(token) ws.send(JSON.stringify({ token }));
    navigator.geolocation.getCurrentPosition(pos => {
  if(ws && ws.readyState === WebSocket.OPEN){
    ws.send(JSON.stringify({
      type: "LOCATION_UPDATE",
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude
    }));
  }
}, err => log(err), { enableHighAccuracy: true });   


  log("WebSocket connected");
  log(role);


  };

  ws.onclose = () => {
    log("WebSocket disconnected, retry in 3s");
    setTimeout(connectWS, 3000);
  };

  ws.onmessage = handleWSMessage;
}
connectWS();

// HANDLE WEBSOCKET MESSAGES 
function handleWSMessage(e){
  try {
    const msg = JSON.parse(e.data);

    // NEW ALERT
    if(msg.type === "VALIDATE_ALERT"){
      const a = msg;
      log(msg);
      activeAlerts[a.alertId] = a;

      // Map marker
      emergencyMarkers[a.alertId] = L.marker([a.latitude,a.longitude]).addTo(map).bindPopup(a.name);
      map.setView([a.latitude,a.longitude], 15);

      // Table row
      let actionHTML = '';
      if(role === 'admin'){
        actionHTML = `<button class="resolve" onclick="resolve(${a.alertId})">Resolve</button>`;
      } else {
        actionHTML = `<button class="accept" onclick="respond(${a.alertId}, true)">Accept</button>
                      <button class="reject" onclick="respond(${a.alertId}, false)">Reject</button>`;
      }

      const row = document.getElementById("a"+a.alertId);
      if(!row){ // prevent duplicate rows
        rows.innerHTML += `
          <tr id="a${a.alertId}">
            <td>${a.name}</td>
            <td>${a.phone}</td>
            <td>${a.message||""}</td>
            <td>${actionHTML}</td>
          </tr>`;
      }
    }

    // ALERT RESOLVED
    if(msg.type==="ALERT_RESOLVED"){
      const row = document.getElementById("a"+msg.alertId);
      if(row) row.style.opacity = 0.5;

      if(emergencyMarkers[msg.alertId]) map.removeLayer(emergencyMarkers[msg.alertId]);
      if(responderMarkers[msg.alertId]) map.removeLayer(responderMarkers[msg.alertId]);
      if(routeLines[msg.alertId]) map.removeLayer(routeLines[msg.alertId]);

      delete activeAlerts[msg.alertId];
    }

    // EMERGENCY ASSIGNMENT (self-navigation)
    if(msg.type === "EMERGENCY_ASSIGNMENT" && role !== 'admin'){
      activeAlerts[msg.alertId] = msg;
      drawResponderRoute(msg.alertId, msg.latitude, msg.longitude);
    }

    // RESPONDER ACCEPTED (victim view)
    if(msg.type === "RESPONDER_ACCEPTED"){
      const { responder, alertId } = msg;
      trackResponder(responder, alertId);
    }

  } catch(err){
    log("WS message error:", err);
  }
}

// ADMIN ACTION
function resolve(alertId){
  if(ws && ws.readyState === WebSocket.OPEN)
    ws.send(JSON.stringify({type:"RESOLVE_ALERT", alertId}));
}

// RESPONDER ACTION
function respond(alertId, accept){
  if(ws && ws.readyState === WebSocket.OPEN)
    ws.send(JSON.stringify({type:"RESPONDER_RESPONSE", alertId, accept}));

  // Update table
  const row = document.getElementById("a"+alertId);
  if(row) row.cells[3].innerHTML = accept ? "Accepted" : "Rejected";
}


// DRAW ROUTE FOR RESPONDER (self-navigation)
async function drawResponderRoute(alertId, destLat, destLng){
  if(!navigator.geolocation) return;

  function updateRoute(){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const start = [pos.coords.latitude, pos.coords.longitude];
      const end = [destLat, destLng];

      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        const resp = await fetch(url);
        const data = await resp.json();
        if(!data.routes || data.routes.length===0) return;

        const coords = data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);

        if(responderMarkers[alertId]) map.removeLayer(responderMarkers[alertId]);
        responderMarkers[alertId] = L.marker(coords[0], {icon:L.icon({iconUrl:"responder.png",iconSize:[32,32]})}).addTo(map);

        if(routeLines[alertId]) map.removeLayer(routeLines[alertId]);
        routeLines[alertId] = L.polyline(coords, {color:"blue"}).addTo(map);

      } catch(err){ console.error("drawResponderRoute error:", err); }

    }, err=>console.error("Geolocation error:", err), {enableHighAccuracy:true});
  }

  updateRoute(); // initial
  navigator.geolocation.watchPosition(pos=>{
    updateRoute();
    // Send live location updates
    if(ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({type:"LOCATION_UPDATE", latitude: pos.coords.latitude, longitude: pos.coords.longitude}));
    }
  }, err=>log(err), {enableHighAccuracy:true});
}
</script>

<div id="debugPanel" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  background: rgba(0,0,0,0.7);
  color: white;
  font-size: 12px;
  z-index: 9999;
  padding: 5px;
  font-family: monospace;
"></div>

</body>
</html>
