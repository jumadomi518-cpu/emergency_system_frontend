<!DOCTYPE html>
<html>
<head>
  <title>Emergency Response Dashboard</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Poppins",sans-serif;}
    body { padding:10px; }
    h2 { text-align:center; margin-bottom:10px; }
    #map { height:400px; margin-bottom:10px; }
    table { width:100%; border-collapse:collapse; }
    th,td { border:1px solid #ccc; padding:6px; text-align:center; }
    button { padding:5px 8px; border:none; border-radius:4px; cursor:pointer; }
    .accept { background:green; color:white;}
    .reject { background:red; color:white;}
    .resolve { background:purple; color:white;}
    .routeOption { background:#007bff; color:white; margin:2px;}
    #routeInfo { margin-top:8px; font-size:14px; }
    #debugPanel {
      position:fixed; bottom:0; left:0; width:100%;
      max-height:150px; overflow-y:auto;
      background:rgba(0,0,0,0.8); color:#0f0;
      font-size:11px; padding:5px; font-family:monospace;
    }
  </style>
</head>
<body>

<h2>Emergency Response Dashboard</h2>
<div id="map"></div>
<div id="routeInfo"></div>

<table>
<thead>
<tr><th>Name</th><th>Phone</th><th>Message</th><th>Action</th></tr>
</thead>
<tbody id="rows"></tbody>
</table>

<div id="debugPanel"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// LOG
function log(msg){
  const panel = document.getElementById("debugPanel");
  const time = new Date().toLocaleTimeString();
  panel.innerText += `[${time}] ${typeof msg==="object"?JSON.stringify(msg):msg}\n`;
  panel.scrollTop = panel.scrollHeight;
}

// CONFIG
const WS_URL = "wss://campus-emergency-server.onrender.com";
const role = localStorage.getItem("role");
let ws;

// MAP
const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const emergencyMarkers = {};
const responderMarkers = {};
const routeLines = {}; // only selected route per alert
let currentWatchId = null;

// ROTATING ICON
const responderIcon = L.divIcon({
  html:`<div id="responderArrow" style="
        width:30px;height:30px;
        background:url('https://cdn-icons-png.flaticon.com/512/684/684908.png') no-repeat center;
        background-size:contain;
        transform:rotate(0deg);"></div>`,
  className:"",
  iconSize:[30,30]
});

// WEBSOCKET
function connectWS(){
  ws = new WebSocket(WS_URL);

  ws.onopen = ()=>{
    const token = localStorage.getItem("token");
    if(token) ws.send(JSON.stringify({token}));
    log("WS Connected");
  };

  ws.onclose = ()=>{
    log("WS Reconnecting...");
    setTimeout(connectWS,3000);
  };

  ws.onmessage = handleWSMessage;
}
connectWS();

// HANDLE WS
function handleWSMessage(e){
  const msg = JSON.parse(e.data);

  if(msg.type==="VALIDATE_ALERT"){
    addAlertToUI(msg);
  }

  if(msg.type==="ALERT_RESOLVED"){
    removeAlert(msg.alertId);
  }

  if(msg.type==="EMERGENCY_ASSIGNMENT" && role!=="admin"){
    startNavigation(msg.alertId, msg.latitude, msg.longitude);
  }
}

// ALERT UI
function addAlertToUI(msg){
  if(!emergencyMarkers[msg.alertId]){
    emergencyMarkers[msg.alertId] =
      L.marker([msg.latitude,msg.longitude]).addTo(map);
  }

  const row = document.createElement("tr");
  row.innerHTML=`
    <td>${msg.name}</td>
    <td>${msg.phone}</td>
    <td>${msg.message||""}</td>
    <td>
      <button class="accept" onclick="respond(${msg.alertId},true)">Accept</button>
      <button class="reject" onclick="respond(${msg.alertId},false)">Reject</button>
    </td>
  `;
  document.getElementById("rows").appendChild(row);
}

function removeAlert(id){
  if(emergencyMarkers[id]) map.removeLayer(emergencyMarkers[id]);
  if(routeLines[id]) map.removeLayer(routeLines[id]);
  delete routeLines[id];
}

// RESPOND
function respond(alertId,accept){
  ws.send(JSON.stringify({type:"RESPONDER_RESPONSE",alertId,accept}));
}

// NAVIGATION
function startNavigation(alertId,destLat,destLng){

  if(currentWatchId) navigator.geolocation.clearWatch(currentWatchId);

  if(!responderMarkers[alertId]){
    responderMarkers[alertId] =
      L.marker([0,0],{icon:responderIcon}).addTo(map);
  }

  currentWatchId = navigator.geolocation.watchPosition(pos=>{
    const startLat = pos.coords.latitude;
    const startLng = pos.coords.longitude;

    updateHeading(startLat,startLng,destLat,destLng);
    fetchRoutes(alertId,startLat,startLng,destLat,destLng);

    ws.send(JSON.stringify({
      type:"LOCATION_UPDATE",
      alertId,
      latitude:startLat,
      longitude:startLng
    }));

  },err=>console.error(err),{enableHighAccuracy:true});
}

// FETCH MULTIPLE ROUTES
function fetchRoutes(alertId,sLat,sLng,dLat,dLng){

  fetch(`https://router.project-osrm.org/route/v1/driving/${sLng},${sLat};${dLng},${dLat}?alternatives=true&overview=full&geometries=geojson`)
  .then(r=>r.json())
  .then(data=>{
    if(!data.routes) return;

    const routeDiv = document.getElementById("routeInfo");
    routeDiv.innerHTML="";

    data.routes.forEach((route,index)=>{

      const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
      const distance = (route.distance/1000).toFixed(2);
      const duration = (route.duration/60).toFixed(1);

      const btn = document.createElement("button");
      btn.className="routeOption";
      btn.innerText=`Route ${index+1} - ${distance} km - ${duration} min`;

      btn.onclick=()=>{
        // Remove previous route
        if(routeLines[alertId]) map.removeLayer(routeLines[alertId]);

        routeLines[alertId] = L.polyline(coords,{color:"blue"}).addTo(map);
        map.fitBounds(routeLines[alertId].getBounds());

        // Clear buttons after selection
        routeDiv.innerHTML=`Selected Route: ${distance} km - ${duration} min`;

        // Send selection to server
        ws.send(JSON.stringify({
          type:"SELECTED_ROUTE",
          alertId,
          routeIndex:index,
          distance,
          duration,
          geometry:coords
        }));

        log(`Selected route ${index+1} for alert ${alertId}`);
      };

      routeDiv.appendChild(btn);
    });
  });
}

// ROTATION 
function updateHeading(lat1,lng1,lat2,lng2){
  const dLon = (lng2-lng1);
  const y = Math.sin(dLon)*Math.cos(lat2);
  const x = Math.cos(lat1)*Math.sin(lat2)-
            Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  let brng = Math.atan2(y,x)*180/Math.PI;
  brng = (brng+360)%360;

  const arrow = document.getElementById("responderArrow");
  if(arrow) arrow.style.transform=`rotate(${brng}deg)`;
}
</script>
</body>
</html>
